<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Panel de Seguridad</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/"><i class="fas fa-shield-alt"></i> Seguridad</a>
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="/admin">Admin</a>
          <a class="nav-link" href="/logout">Salir</a>
        </div>
      </div>
    </nav>

    <div class="container mt-5">
      <h2>üîí Panel de Seguridad del Sistema</h2>
      
      <!-- Alertas de intentos fallidos -->
      <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <strong>‚ö†Ô∏è Advertencia de Seguridad:</strong>
        <p>Se han detectado {{ suspicious_ips|length }} IP(s) con m√∫ltiples intentos fallidos en las √∫ltimas 24 horas.</p>
      </div>

      <!-- IPs Sospechosas -->
      <div class="card mb-4">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0">üö® IPs con Intentos Fallidos M√∫ltiples (√∫ltimas 24h)</h5>
        </div>
        <div class="card-body">
          {% if suspicious_ips %}
          <table class="table table-striped">
            <thead class="table-light">
              <tr>
                <th>Direcci√≥n IP</th>
                <th>Intentos Fallidos</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              {% for ip, attempts in suspicious_ips %}
              <tr>
                <td><code>{{ ip }}</code></td>
                <td><span class="badge bg-danger">{{ attempts }}</span></td>
                <td>
                  <button class="btn btn-sm btn-warning" onclick="alert('Funcionalidad de bloqueo de IP en desarrollo')">
                    Bloquear IP
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <p class="text-muted">No hay IPs sospechosas en las √∫ltimas 24 horas.</p>
          {% endif %}
        </div>
      </div>

      <!-- √öltimos Intentos Fallidos -->
      <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">‚ö†Ô∏è √öltimos 30 Intentos Fallidos</h5>
        </div>
        <div class="card-body">
          {% if failed_attempts %}
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead class="table-light">
                <tr>
                  <th>Usuario</th>
                  <th>IP</th>
                  <th>Hora</th>
                  <th>User Agent</th>
                </tr>
              </thead>
              <tbody>
                {% for attempt in failed_attempts %}
                <tr>
                  <td>{{ attempt.username }}</td>
                  <td><code>{{ attempt.ip_address }}</code></td>
                  <td>{{ attempt.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                  <td><small class="text-muted">{{ attempt.user_agent[:50] }}...</small></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted">No hay intentos fallidos registrados.</p>
          {% endif %}
        </div>
      </div>

      <!-- Sesiones Activas -->
      <div class="card mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">‚úì Sesiones Activas</h5>
        </div>
        <div class="card-body">
          {% if active_sessions %}
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead class="table-light">
                <tr>
                  <th>Usuario</th>
                  <th>IP</th>
                  <th>Creada</th>
                  <th>√öltima Actividad</th>
                  <th>Acci√≥n</th>
                </tr>
              </thead>
              <tbody>
                {% for sess in active_sessions %}
                <tr>
                  <td>{{ sess.user.username }}</td>
                  <td><code>{{ sess.ip_address }}</code></td>
                  <td>{{ sess.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td>{{ sess.last_activity.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td>
                    <form method="POST" action="/logout-session/{{ sess.id }}" style="display:inline">
                      <button type="submit" class="btn btn-sm btn-danger" 
                              onclick="return confirm('Cerrar esta sesi√≥n?')">
                        Cerrar
                      </button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted">No hay sesiones activas.</p>
          {% endif %}
        </div>
      </div>

      <!-- Enlaces de Administraci√≥n -->
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">‚öôÔ∏è Administraci√≥n de Seguridad</h5>
        </div>
        <div class="card-body">
          <div class="btn-group" role="group">
            <a href="/setup-2fa" class="btn btn-primary">
              <i class="fas fa-lock"></i> Configurar 2FA
            </a>
            <a href="/admin/security-log" class="btn btn-secondary">
              <i class="fas fa-list"></i> Ver Log Completo
            </a>
            <button class="btn btn-warning" disabled>
              <i class="fas fa-ban"></i> Bloquear IPs (pr√≥ximo)
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
