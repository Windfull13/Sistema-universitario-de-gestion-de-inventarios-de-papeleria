<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mis Pr√©stamos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .overdue-alert {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
      }
      .rental-card {
        transition: transform 0.2s;
      }
      .rental-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mb-4">
      <div class="container">
        <a class="navbar-brand" href="/">Papeler√≠a</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/student/rentals">Mis Pr√©stamos</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/student/statistics">Estad√≠sticas</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/admin/settings">Configuraci√≥n</a>
            </li>
          </ul>
        </div>
        <div class="ms-auto d-flex gap-2 align-items-center">
          {% if current_user %}
            <span class="text-muted">{{ current_user.username or current_user.email }}</span>
            <a class="btn btn-sm btn-outline-secondary" href="/logout">Cerrar sesi√≥n</a>
          {% endif %}
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üì¶ Mis Pr√©stamos</h2>
        <a href="/" class="btn btn-outline-primary">‚Üê Volver al cat√°logo</a>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ msg }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Resumen de alertas -->
      {% if overdue_rentals %}
        <div class="alert alert-danger alert-dismissible fade show overdue-alert" role="alert">
          <h4 class="alert-heading">‚ö†Ô∏è Rentas Vencidas</h4>
          <p>Tienes <strong>{{ overdue_rentals|length }}</strong> pr√©stamo(s) vencido(s). Por favor, devuelve los items lo antes posible.</p>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endif %}

      <!-- Tabs para clasificar pr√©stamos -->
      <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button" role="tab">
            Activos <span class="badge bg-primary ms-2">{{ active_rentals|length }}</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="overdue-tab" data-bs-toggle="tab" data-bs-target="#overdue" type="button" role="tab">
            Vencidos <span class="badge bg-danger ms-2">{{ overdue_rentals|length }}</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="returned-tab" data-bs-toggle="tab" data-bs-target="#returned" type="button" role="tab">
            Devueltos <span class="badge bg-secondary ms-2">{{ returned_rentals|length }}</span>
          </button>
        </li>
      </ul>

      <div class="tab-content">
        <!-- Tab: Pr√©stamos Activos -->
        <div class="tab-pane fade show active" id="active" role="tabpanel">
          {% if active_rentals %}
            <div class="row g-3">
              {% for rental in active_rentals %}
                <div class="col-md-6 col-lg-4">
                  <div class="card rental-card h-100">
                    <div class="card-body">
                      <h5 class="card-title">{{ rental.item.name if rental.item else 'Item no encontrado' }}</h5>
                      <p class="card-text text-muted">Cantidad: {{ rental.qty }}</p>
                      
                      <div class="mb-3">
                        <small class="text-muted">Per√≠odo de renta:</small>
                        <p class="mb-1">
                          <strong>Inicio:</strong> {{ rental.rent_start_date.strftime('%d/%m/%Y') if rental.rent_start_date else 'N/A' }}
                        </p>
                        <p class="mb-0">
                          <strong>Vence:</strong> {{ rental.rent_due_date.strftime('%d/%m/%Y') if rental.rent_due_date else 'N/A' }}
                        </p>
                      </div>

                      <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">
                          50%
                        </div>
                      </div>

                      <p class="card-text">
                        <small>Duraci√≥n: <strong>{{ rental.rent_days }} d√≠as</strong></small>
                      </p>
                    </div>
                    <div class="card-footer bg-transparent">
                      <div class="btn-group w-100" role="group">
                        <form method="post" action="/api/rentals/{{ rental.id }}/return" style="flex: 1; margin-right: 2px;">
                          <button type="submit" class="btn btn-sm btn-success w-100">Devolver</button>
                        </form>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#extensionModal{{ rental.id }}">
                          Extender
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Modal de solicitud de extensi√≥n -->
                  <div class="modal fade" id="extensionModal{{ rental.id }}" tabindex="-1">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Solicitar Extensi√≥n</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <form method="post" action="/api/rentals/{{ rental.id }}/request-extension">
                          <div class="modal-body">
                            <p>¬øCu√°ntos d√≠as adicionales necesitas para este pr√©stamo?</p>
                            <div class="mb-3">
                              <label class="form-label">D√≠as de extensi√≥n</label>
                              <select name="extension_days" class="form-select">
                                <option value="3">3 d√≠as</option>
                                <option value="5">5 d√≠as</option>
                                <option value="7">7 d√≠as (1 semana)</option>
                                <option value="10">10 d√≠as</option>
                                <option value="14">14 d√≠as (2 semanas)</option>
                                <option value="21">21 d√≠as (3 semanas)</option>
                                <option value="30">30 d√≠as (1 mes)</option>
                              </select>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Solicitar Extensi√≥n</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-info">
              No tienes pr√©stamos activos. ¬°Explora el cat√°logo y renta items!
            </div>
          {% endif %}
        </div>

        <!-- Tab: Pr√©stamos Vencidos -->
        <div class="tab-pane fade" id="overdue" role="tabpanel">
          {% if overdue_rentals %}
            <div class="row g-3">
              {% for rental in overdue_rentals %}
                <div class="col-md-6 col-lg-4">
                  <div class="card rental-card h-100 border-danger">
                    <div class="card-header bg-danger text-white">
                      ‚ö†Ô∏è VENCIDO HACE {{ rental.days_overdue }} D√çA{% if rental.days_overdue != 1 %}S{% endif %}
                    </div>
                    <div class="card-body">
                      <h5 class="card-title text-danger">{{ rental.item.name if rental.item else 'Item no encontrado' }}</h5>
                      <p class="card-text text-muted">Cantidad: {{ rental.qty }}</p>
                      
                      <div class="mb-3">
                        <small class="text-muted">Per√≠odo de renta:</small>
                        <p class="mb-1">
                          <strong>Inicio:</strong> {{ rental.rent_start_date.strftime('%d/%m/%Y') if rental.rent_start_date else 'N/A' }}
                        </p>
                        <p class="mb-0">
                          <strong>Vencimiento:</strong> <span class="text-danger fw-bold">{{ rental.rent_due_date.strftime('%d/%m/%Y') if rental.rent_due_date else 'N/A' }}</span>
                        </p>
                      </div>
                    </div>
                    <div class="card-footer bg-light">
                      <p class="text-danger mb-2">
                        <small><strong>Por favor, devuelve este item lo antes posible</strong></small>
                      </p>
                      <form method="post" action="/api/rentals/{{ rental.id }}/return" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-danger w-100">Devolver ahora</button>
                      </form>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-success">
              ¬°Perfecto! No tienes pr√©stamos vencidos.
            </div>
          {% endif %}
        </div>

        <!-- Tab: Pr√©stamos Devueltos -->
        <div class="tab-pane fade" id="returned" role="tabpanel">
          {% if returned_rentals %}
            <div class="row g-3">
              {% for rental in returned_rentals %}
                <div class="col-md-6 col-lg-4">
                  <div class="card rental-card h-100 opacity-75">
                    <div class="card-header bg-secondary text-white">
                      ‚úì DEVUELTO
                    </div>
                    <div class="card-body">
                      <h5 class="card-title">{{ rental.item.name if rental.item else 'Item no encontrado' }}</h5>
                      <p class="card-text text-muted">Cantidad: {{ rental.qty }}</p>
                      
                      <div class="mb-3">
                        <small class="text-muted">Per√≠odo de renta:</small>
                        <p class="mb-1">
                          <strong>Inicio:</strong> {{ rental.rent_start_date.strftime('%d/%m/%Y') if rental.rent_start_date else 'N/A' }}
                        </p>
                        <p class="mb-0">
                          <strong>Vencimiento:</strong> {{ rental.rent_due_date.strftime('%d/%m/%Y') if rental.rent_due_date else 'N/A' }}
                        </p>
                      </div>

                      <p class="card-text">
                        <small>Duraci√≥n: <strong>{{ rental.rent_days }} d√≠as</strong></small>
                      </p>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-info">
              A√∫n no has devuelto ning√∫n pr√©stamo.
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
